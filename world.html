<!DOCTYPE html>
<html>
<head>
	<title>Erintuitive's psychic chatroom</title>	
	<script src="/assets/js/socket.io.js"></script>
	<script src="/assets/js/htmlgl.js"></script>
	<script src="/assets/js/pixi.min.js"></script>
	<script src="/assets/js/pixi.dom.js"></script>
	<script src="/assets/js/jquery.js"></script>
</head>
<body bgcolor="purple">
<img src="/assets/svg/fire_room.svg" alt="torchlight" width="745px" height="440px" style="position: absolute; left: 7px; top: 0;"/>
<div id="staging" style="position: absolute; left: 7px; top: 0;"></div>
<div id="staging2" style="position: absolute; left: 7px; top: 0;"></div>
<style>
	body {
		overflow: hidden;
	}
</style>
<script>
	var app = new PIXI.Application();
	document.getElementById("staging").appendChild(app.view);
	app.stage.interactive = true;
	
	var container = new PIXI.Container();
	app.stage.addChild(container);
	
	var spriteSVGImage_room = "/assets/svg/fire_room.svg";
	var spriteSVGTexture_room = PIXI.Texture.fromImage(spriteSVGImage_room);
	var SpriteSVG_room = new PIXI.Sprite(spriteSVGTexture_room);
	container.addChild(SpriteSVG_room);
	
	var fireContainer = new PIXI.Container();
	app.stage.addChild(fireContainer);
	
	var spriteSVGImage = "/assets/svg/fire_room_torchlight.svg";
	var spriteSVGTexture = PIXI.Texture.fromImage(spriteSVGImage);
	var SpriteSVG = new PIXI.Sprite(spriteSVGTexture);
	fireContainer.addChild(SpriteSVG);
	
	var displacementSprite = new PIXI.Sprite.fromImage("/assets/img/displacement_map.jpg");
	var displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
	fireContainer.addChild(displacementSprite);
	
	var blurFilter = new PIXI.filters.BlurFilter();
	
	fireContainer.filters = [displacementFilter, blurFilter];
	fireContainer.y = 5;
	
	displacementFilter.scale.x = 25;
	displacementFilter.scale.y = -350;
	displacementFilter.rotation = 20;
	
	var count = 0;
	
	app.ticker.add(function(delta) {
		count -= 0.1;
		displacementSprite.y = count * 10;
		blurFilter.blur = count * -0.3;
		if (count == -4.5){
			count = 0;
		}
	});
	//set user id
	//var userId = "local" + Math.random().toString();
	var d = new Date();
	var userId = d.getTime();
	var posX = 0;
	var posY = 0;
	var rightDirection = window.localStorage.getItem("avatarClothed_right");
	var leftDirection = window.localStorage.getItem("avatarClothed_left");
	var players = [userId];
	var playersBody = [[userId, rightDirection, leftDirection, true]];
	var socket = io.connect("/");
	socket.emit("id", userId);
	socket.emit("idBody", playersBody[0]);
	socket.on("players", function(players2){
		players = players2;
	});
	socket.on("playersBody", function(playersBody2){
		playersBody = playersBody2;
	});
	for (i=0; i<players.length; i++){
		for (j=0; j<playersBody.length; j++){
			if(players[i] == playersBody[j][0]){
				var playerElement = playersBody[j][1];
				if(playersBody[j][3] == false) {
					playerElement = playersBody[j][2];
				}
				document.getElementById("staging2").innerHTML = '<div id="' + players[i] + '" class="count_it" style="position: absolute; top: 0; left: 0;">' + playerElement + '</div>';
			}
		}
	}
	$(document).keydown(function(e) {
		switch(e.which) {
			case 37: // left
			moveLeft();
			break;

			case 38: // up
			moveUp();
			break;

			case 39: // right
			moveRight();
			break;

			case 40: // down
			moveDown();
			break;

			default: return; // exit this handler for other keys
		}
		e.preventDefault(); // prevent the default action (scroll / move caret)
	});
	function moveUp() {
		var withAdditionTop = (parseInt(document.getElementById(userId).style.top.replace("px", "")) - 3).toString() + "px";
		document.getElementById(userId).style.top = withAdditionTop;
	}
	function moveDown() {
		var withAdditionBottom = (parseInt(document.getElementById(userId).style.top.replace("px", "")) + 3).toString() + "px";	
		document.getElementById(userId).style.top = withAdditionBottom;
	}
	function moveLeft() {
		var withAdditionLeft = (parseInt(document.getElementById(userId).style.left.replace("px", "")) - 3).toString() + "px";
		document.getElementById(userId).innerHTML = leftDirection;
		document.getElementById(userId).style.left = withAdditionLeft;
	}
	function moveRight() {
		var withAdditionRight = (parseInt(document.getElementById(userId).style.left.replace("px", "")) + 3).toString() + "px";
		document.getElementById(userId).style.left = withAdditionRight;
		document.getElementById(userId).innerHTML = rightDirection;
	}
	socket.on("connect", function(){
		setInterval(function(){
			socket.on('firstPlaceAvatar', function(id, left, top, facingRight){
				var element = '';
				if(userId != id){
					if( players.indexOf(id) == -1 ){
						for(j=0; j < playersBody.length; j++){
							if(id == playersBody[j][0]){
								element = playersBody[j][1];
								if(playersBody[j][3] == false){
									element = playersBody[j][2];
								}
								document.getElementById("staging2").innerHTML += '<div id="' + id + '" class="count_it" style="position: absolute; top: ' + top + '; ' + left + ';">' + element + '</div>';
								players.push(id);
							}
						}
					}
					else {
						document.getElementById(id).style.left = left;
						document.getElementById(id).style.top = top;
						document.getElementById(id).innerHTML = element;
					}
				}
			});
			socket.emit("firstPlace", document.getElementById(userId).innerHTML, userId, document.getElementById(userId).style.left, document.getElementById(userId).style.top, true);
		}, 30);
	});
</script>
</body>
</html>