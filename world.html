<!DOCTYPE html>
<html>
<head>
	<title>Erintuitive's psychic chatroom</title>	
	<script src="/assets/js/socket.io.js"></script>
	<script src="/assets/js/htmlgl.js"></script>
	<script src="/assets/js/pixi.min.js"></script>
	<script src="/assets/js/pixi.dom.js"></script>
	<script src="/assets/js/jquery.js"></script>
	<script src="/assets/js/dom-to-image.min.js"></script>
	<script src="/assets/js/blob-util.min.js"></script>
</head>
<body bgcolor="purple">
<img src="/assets/svg/fire_room.svg" alt="torchlight" width="745px" height="440px" style="position: absolute; left: 7px; top: 0;"/>
<div id="staging" style="position: absolute; left: 7px; top: 0;"></div>
<div id="staging2" style="position: absolute; left: 7px; top: 0;"></div>
<canvas id="myCanvas" width="800" height="800" style="border:1px solid #000000; margin-left: 1000px;"></canvas>
<style>
	body {
		overflow: hidden;
	}
</style>
<script>
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext('2d');

	var app = new PIXI.Application();
	document.getElementById("staging").appendChild(app.view);
	app.stage.interactive = true;
	
	var container = new PIXI.Container();
	app.stage.addChild(container);
	
	var spriteSVGImage_room = "/assets/svg/fire_room.svg";
	var spriteSVGTexture_room = PIXI.Texture.fromImage(spriteSVGImage_room);
	var SpriteSVG_room = new PIXI.Sprite(spriteSVGTexture_room);
	container.addChild(SpriteSVG_room);
	
	var fireContainer = new PIXI.Container();
	app.stage.addChild(fireContainer);
	
	var spriteSVGImage = "/assets/svg/fire_room_torchlight.svg";
	var spriteSVGTexture = PIXI.Texture.fromImage(spriteSVGImage);
	var SpriteSVG = new PIXI.Sprite(spriteSVGTexture);
	fireContainer.addChild(SpriteSVG);
	
	var displacementSprite = new PIXI.Sprite.fromImage("/assets/img/displacement_map.jpg");
	var displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
	fireContainer.addChild(displacementSprite);
	
	var blurFilter = new PIXI.filters.BlurFilter();
	
	fireContainer.filters = [displacementFilter, blurFilter];
	fireContainer.y = 5;
	
	displacementFilter.scale.x = 25;
	displacementFilter.scale.y = -350;
	displacementFilter.rotation = 20;

	var personContainer = new PIXI.Container();
	app.stage.addChild(personContainer);
	
	var count = 0;
	
	app.ticker.add(function(delta) {
		count -= 0.1;
		displacementSprite.y = count * 10;
		blurFilter.blur = count * -0.3;
		if (count == -4.5){
			count = 0;
		}
	});
	//set user id
	//var userId = "local" + Math.random().toString();
	var d = new Date();
	var userId = d.getTime();
	var posX = 0;
	var posY = 0;
	var right = window.localStorage.getItem("avatarClothed_right");
	var left = window.localStorage.getItem("avatarClothed_left");
	var players = [userId];
	var socket = io.connect("/");
	socket.emit("id", userId);
	socket.on("players", function(players2){
		players = players2;
	});

	//make Blob
	/*var myData = '<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><foreignObject width="100%" height="100%">' + right + '</foreignObject></svg>';
	var mySVG  = new Blob([myData], {type: 'image/svg+xml'});
	console.log(mySVG);
	blobUtil.blobToBase64String(mySVG).then(function(base64String){
		document.getElementById("test").setAttribute("src", base64String);
		ctx.drawImage(document.getElementById("test"), 0, 0);
	}).catch(function(err) {
		console.error(err);
	});*/

	for (i=0; i<players.length; i++){
		document.getElementById("staging2").innerHTML = '<div id="' + players[i] + '" class="count_it" style="position: absolute; top: 0; left: 0;"><div style="margin-left: 25px;">' + right + '</div>';
		domtoimage.toPng(document.getElementById(players[i])).then(function (dataUrl) {
			var img = new Image();
			img.src = dataUrl;
			img.onload = function() {
				document.getElementById("staging2").appendChild(img);
				ctx.drawImage(img, 0, 0);
			}
		}).catch(function (error){
			console.error(error);
		});
	}
	/////////////
	
	var canvas = document.getElementById('myCanvas');
	var ctx = canvas.getContext('2d');
	var data = `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">' +
		'<foreignObject width="100%" height="100%">${right}</foreignObject></svg>`;
	var DOMURL = window.URL || window.webkitURL || window;
	var img = new Image();
	var svg = new Blob([data], {type: 'image/svg+xml'});
	var url = DOMURL.createObjectURL(svg);
	img.onload = function() {
		document.getElementById("test").setAttribute("src", url);
		var thePerson = PIXI.Texture.fromImage(webkitURL);
		var SpriteThePerson = new PIXI.Sprite(thePerson);
		personContainer.addChild(SpriteThePerson);
	}
	/////////////

	$(document).keydown(function(e) {
		switch(e.which) {
			case 37: // left
			moveLeft();
			break;

			case 38: // up
			moveUp();
			break;

			case 39: // right
			moveRight();
			break;

			case 40: // down
			moveDown();
			break;

			default: return; // exit this handler for other keys
		}
		e.preventDefault(); // prevent the default action (scroll / move caret)
	});
	function moveUp() {
		var withAdditionTop = (parseInt(document.getElementById(userId).style.top.replace("px", "")) - 3).toString() + "px";
		document.getElementById(userId).style.top = withAdditionTop;
	}
	function moveDown() {
		var withAdditionBottom = (parseInt(document.getElementById(userId).style.top.replace("px", "")) + 3).toString() + "px";	
		document.getElementById(userId).style.top = withAdditionBottom;
	}
	function moveLeft() {
		var withAdditionLeft = (parseInt(document.getElementById(userId).style.left.replace("px", "")) - 3).toString() + "px";
		document.getElementById(userId).innerHTML = left;
		document.getElementById(userId).style.left = withAdditionLeft;
	}
	function moveRight() {
		var withAdditionRight = (parseInt(document.getElementById(userId).style.left.replace("px", "")) + 3).toString() + "px";
		document.getElementById(userId).style.left = withAdditionRight;
		document.getElementById(userId).innerHTML = right;
	}
	socket.on("connect", function(){
		setInterval(function(){
			socket.on('firstPlaceAvatar', function(element, id, left, top, facingRight){
				if(userId != id){
					if( players.indexOf(id) == -1 ){
						document.getElementById("staging2").innerHTML += '<div id="' + id + '" class="count_it" style="position: absolute; top: ' + top + '; ' + left + ';">' + element + '</div>';
						players.push(id);
					}
					else {
						document.getElementById(id).style.left = left;
						document.getElementById(id).style.top = top;
						document.getElementById(id).innerHTML = element;
					}
				}
			});
			//socket.emit("firstPlace", document.getElementById(userId).innerHTML, userId, document.getElementById(userId).style.left, document.getElementById(userId).style.top, true);
		}, 30);
	});
</script>
</body>
</html>