<!DOCTYPE html>
<html>
<head>
	<title>Erintuitive's psychic chatroom</title>	
	<script src="/assets/js/socket.io.js"></script>
	<script src="/assets/js/htmlgl.js"></script>
	<script src="/assets/js/pixi.min.js"></script>
	<script src="/assets/js/pixi.dom.js"></script>
	<script src="/assets/js/jquery.js"></script>
	<script src="/assets/js/dom-to-image.min.js"></script>
	<script src="/assets/js/blob-util.min.js"></script>
</head>
<body bgcolor="purple">
<img src="/assets/svg/fire_room.svg" alt="torchlight" width="745px" height="440px" style="position: absolute; left: 7px; top: 0;"/>
<div id="staging" style="position: absolute; left: 7px; top: 0;"></div>
<div id="staging2" style="position: absolute; left: 7px; top: 0; margin-left: 1000px;"></div>
<canvas id="myCanvas" width="440" height="370" style="border:1px solid #000000; margin-left: 1000px;"></canvas>
<div id="playersDiv" style="position: fixed; top: 0; left: 0;"></div>
<style>
	body {
		overflow: hidden;
	}
</style>
<script>
	//Facebook stuff
	//var userId = '';
	window.fbAsyncInit = function() {
		FB.init({
		  appId            : '817064305070781',
		  autoLogAppEvents : true,
		  xfbml            : true,
		  version          : 'v2.9'
		});
		FB.AppEvents.logPageView();
		FB.getLoginStatus(function(response){
			if (response.status === 'connected'){
				getMe();
			}
			else if (response.status === 'not_authorized'){
				document.getElementById("itemPreview").innerHTML = "test";
			}
			else {
				
			}
		});
	};
	(function(d, s, id){
		var js, fjs = d.getElementsByTagName(s)[0];
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.id = id;
		js.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.11&appId=817064305070781";
		fjs.parentNode.insertBefore(js, fjs);
		//test
	}(document, 'script', 'facebook-jssdk'));
	function getMe() {
		FB.api('/me', function(response) {
			//userId = response.id;
		});
	}
	//begin PIXI code
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext('2d');

	var app = new PIXI.Application();
	document.getElementById("staging").appendChild(app.view);
	app.stage.interactive = true;
	
	var container = new PIXI.Container();
	app.stage.addChild(container);
	
	var spriteSVGImage_room = "/assets/svg/fire_room.svg";
	var spriteSVGTexture_room = PIXI.Texture.fromImage(spriteSVGImage_room);
	var SpriteSVG_room = new PIXI.Sprite(spriteSVGTexture_room);
	container.addChild(SpriteSVG_room);
	
	var fireContainer = new PIXI.Container();
	app.stage.addChild(fireContainer);
	
	var spriteSVGImage = "/assets/svg/fire_room_torchlight.svg";
	var spriteSVGTexture = PIXI.Texture.fromImage(spriteSVGImage);
	var SpriteSVG = new PIXI.Sprite(spriteSVGTexture);
	fireContainer.addChild(SpriteSVG);
	
	var displacementSprite = new PIXI.Sprite.fromImage("/assets/img/displacement_map.jpg");
	var displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
	fireContainer.addChild(displacementSprite);
	
	var blurFilter = new PIXI.filters.BlurFilter();
	
	fireContainer.filters = [displacementFilter, blurFilter];
	fireContainer.y = 5;
	
	displacementFilter.scale.x = 25;
	displacementFilter.scale.y = -350;
	displacementFilter.rotation = 20;

	var personContainer = new PIXI.Container();
	app.stage.addChild(personContainer);
	personContainer.y = 0;
	personContainer.x = 0;
	
	var count = 0;
	
	app.ticker.add(function(delta) {
		count -= 0.1;
		displacementSprite.y = count * 10;
		blurFilter.blur = count * -0.3;
		if (count == -4.5){
			count = 0;
		}
	});
	//set user id
	//var userId = "local" + Math.random().toString();
	var d = new Date();
	var userId = d.getTime();

	var posX = 0;
	var posY = 0;
	var right = window.localStorage.getItem("avatarClothed_right");
	var left = window.localStorage.getItem("avatarClothed_left");
	var players = {};
	var socket = io.connect("/");
	
	var arrayCharLocal = [];

	socket.emit("newPlayer");
	socket.on("howManyPlayersResponse", function(howMany){
		console.log(howMany);
		if(howMany == 0){
			document.getElementById("playersDiv").innerHTML += '<span><div id="' + userId + '" class="count_it" style="position: absolute; top: 0; left: 0;"><div style="margin-left: 45px;">' + right + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 1){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 10px; left: 75px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 2){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 100px; left: 15px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + right + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 3){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 10px; left: 75px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 4){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 310px; left: 85px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 5){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 7px; left: 345px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 6){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 200px; left: 200px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 7){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 260px; left: 75px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it" >' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 8){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 390px; left: 195px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it">' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 9){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 310px; left: 305px;"><div style="margin-left: 45px;"><div id="' + userId + '" class="count_it">' + right + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else if (howMany == 10){
			document.getElementById("playersDiv").innerHTML += '<span style="position: absolute; top: 10px; left: 259px;"><div style="margin-left: 39px;"><div id="' + userId + '" class="count_it">' + left + '</div></span>';
			setInterval(updateMyPlayers, 1600);
		}
		else {

		}
	});
	function updateMyPlayers(){
		var id = userId;
		var char = document.getElementById(userId);
		var x = document.getElementById(userId).style.left;
		var y = document.getElementById(userId).style.top;
		socket.emit("updatePlayers", id, char, x, y);
	}
	socket.on("updatePlayersResponse", function(players){
		for(player in players){
			if(document.getElementById(player) == null){
				document.getElementById("playersDiv").innerHTML += '<div id="' + player + '" class="count_it" style="position: absolute; top: ' + players[player][2] + '; left: ' + players[player][1] + ';"><div style="margin-left: 39px;">' + players[player][0] + '</div>';
			}
		}
	});
</script>
</body>
</html>