<!DOCTYPE html>
<html>
<head>
	<title>Erintuitive's psychic chatroom</title>	
	<script src="/assets/js/socket.io.js"></script>
	<script src="/assets/js/htmlgl.js"></script>
	<script src="/assets/js/pixi.min.js"></script>
	<script src="/assets/js/pixi.dom.js"></script>
	<script src="/assets/js/jquery.js"></script>
	<script src="/assets/js/dom-to-image.min.js"></script>
	<script src="/assets/js/blob-util.min.js"></script>
</head>
<body bgcolor="purple">
<img src="/assets/svg/fire_room.svg" alt="torchlight" width="745px" height="440px" style="position: absolute; left: 7px; top: 0;"/>
<div id="staging" style="position: absolute; left: 7px; top: 0;"></div>
<div id="staging2" style="position: absolute; left: 7px; top: 0; margin-left: 1000px;"></div>
<canvas id="myCanvas" width="440" height="370" style="border:1px solid #000000; margin-left: 1000px;"></canvas>
<div id="playersDiv" style="position: fixed; top: 0; left: 0;"></div>
<!-- message form -->
<div id="form">
	<ul id="messages"></ul>
</div>
<input id="m" autocomplete="off" /><button id="n">Send</button>
<style>
	body {
		overflow: hidden;
	}
	#form {background: #FFF; border: solid 3px; padding: 4px; position: fixed; top: 0px; left: 445px; width: 250px; height: 430px; opacity: 0.8;}
	#m {position: fixed; left: 445px; top: 420px; border: solid 2px;}
	#n {position: fixed; left: 615px; top: 420px; border: solid 2px;}
	#messages {list-style-type: none; margin: 0; padding: 0; overflow: scroll; height: 430px;}
	#messages li {padding: 5px 10px; }
	#messages li:nth-child(odd) { background: #ddd; }
</style>
<script>
	var name = window.localStorage.getItem("name");
	$("#m").focus(function(){
		$(document).keyup(function(e){
			switch(e.which) {
				case 13:
				submit();
			}
		});
		$("#n").click(function(){
			submit();
		})
	});
	var canvas = document.getElementById("myCanvas");
	var ctx = canvas.getContext('2d');

	var app = new PIXI.Application();
	document.getElementById("staging").appendChild(app.view);
	app.stage.interactive = true;
	
	var container = new PIXI.Container();
	app.stage.addChild(container);
	
	var spriteSVGImage_room = "/assets/svg/fire_room.svg";
	var spriteSVGTexture_room = PIXI.Texture.fromImage(spriteSVGImage_room);
	var SpriteSVG_room = new PIXI.Sprite(spriteSVGTexture_room);
	container.addChild(SpriteSVG_room);
	
	var fireContainer = new PIXI.Container();
	app.stage.addChild(fireContainer);
	
	var spriteSVGImage = "/assets/svg/fire_room_torchlight.svg";
	var spriteSVGTexture = PIXI.Texture.fromImage(spriteSVGImage);
	var SpriteSVG = new PIXI.Sprite(spriteSVGTexture);
	fireContainer.addChild(SpriteSVG);
	
	var displacementSprite = new PIXI.Sprite.fromImage("/assets/img/displacement_map.jpg");
	var displacementFilter = new PIXI.filters.DisplacementFilter(displacementSprite);
	fireContainer.addChild(displacementSprite);
	
	var blurFilter = new PIXI.filters.BlurFilter();
	
	fireContainer.filters = [displacementFilter, blurFilter];
	fireContainer.y = 5;
	
	displacementFilter.scale.x = 25;
	displacementFilter.scale.y = -350;
	displacementFilter.rotation = 20;

	var personContainer = new PIXI.Container();
	app.stage.addChild(personContainer);
	personContainer.y = 0;
	personContainer.x = 0;
	
	var count = 0;
	
	app.ticker.add(function(delta) {
		count -= 0.1;
		displacementSprite.y = count * 10;
		blurFilter.blur = count * -0.3;
		if (count == -4.5){
			count = 0;
		}
	});
	//set user id
	//var userId = "local" + Math.random().toString();
	var d = new Date();
	var userId = d.getTime();
	var posX = 0;
	var posY = 0;
	var right = window.localStorage.getItem("avatarClothed_right");
	var left = window.localStorage.getItem("avatarClothed_left");
	var players = {};
	var socket = io.connect("/");

	function submit() {
		socket.emit("msg", $("#m").val(), name, userId);
		$("#m").val('');
	}
	socket.on("msgReturn", function(value, name2){
		if(value != "" && value != null){
			$("#messages").append("<font color='purple'>" + name2 + "</font>: " + value + "</li><br>");
		}
		var chatWindow = document.getElementById("messages");
		chatWindow.scrollTop = chatWindow.scrollHeight;
	});
	socket.emit("id", userId, right, name);
	setInterval(function(){	
		socket.emit("blinkInterval", userId);
	}, 3000);
	setInterval(function(){
		socket.emit("afk", userId);
	}, 1000);
	socket.on("removePlayerReturn", function(id){
		var element = document.getElementById(id);
		element.parentNode.removeChild(element);
	});
	socket.on("afkReturn", function(id, afk){
		if(document.getElementById(userId) != null){
			var element = document.getElementById(userId);
			var elemName = userId + "afk";
			var elem = document.getElementById(elemName);
			if(id == userId){
				if(afk[`${id}`] <= 8) {
					elem.style.visibility = "hidden";
				}
				else if(afk[`${id}`] > 8){
					elem.style.visibility = "visible";
				}
				else if(afk[`${id}`] > 60){
					socket.emit("removePlayer", id);
					alert("You have been logged out of chat due to messaging inactivity. You can still play a minigame or rejoin the room.");

				}
			}
		}
	});
	socket.on("blinkResponse", function(id){
		if(document.getElementById(id) != null){
			var blink = document.getElementById(id).querySelectorAll(".blink")[0];
			blink.style.visibility = "visible";
			setTimeout(function(){
				blink.style.visibility = "hidden";
			}, 100);
		}
	});
	socket.on('players', function(player2){
		players = player2;
		for(player in players) {
			if(document.getElementById(player) == null){
				document.getElementById("playersDiv").innerHTML += '<div style="position: absolute; webkit-transform: scale(0.85); -ms-transform: scale(0.85); transform: scale(0.85);"><div class="' + player + '" id="' + player + '" style="position: absolute; top: ' + players[player][2] + '; left: ' + players[player][1] + ';" alt="player">' + players[player][0] + '</div><div style="position: absolute; left: ' + (parseInt(players[player][1].replace("px", "")) - 50).toString() + 'px; top: ' + (parseInt(players[player][2].replace("px", "")) + 259).toString() + 'px; webkit-transform: scale(0.45); -ms-transform: scale(0.45); transform: scale(0.45);"><font color="white" size="23px">' + players[player][3] + '</font><br><div id="' + userId + 'afk" style="visibility: hidden; position: relative; left: 35px;"><font size="18" color="silver">(afk)</font></div></div></div></div>';
			}
		}
	});
</script>
</body>
</html>